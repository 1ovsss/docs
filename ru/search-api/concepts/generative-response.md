# Генеративный ответ

Вы можете использовать текстовый поиск {{ search-api-name }} в сочетании с генеративными возможностями [{{ yagpt-name }}](../../foundation-models/concepts/yandexgpt/index.md), чтобы получить на поисковый запрос пользователя единый емкий и понятный _генеративный ответ_, при формировании которого нейросеть анализирует релевантные результаты текстового поиска {{ search-api-name }} по сайтам вашей компании. 

{% include [note-preview-by-request](../../_includes/note-preview.md) %}

Чтобы получить доступ к возможности генеративного ответа, заполните [форму](#contact-form) или обратитесь к вашему аккаунт-менеджеру.

## Поисковый запрос {#request}

Запросы к сервису {{ search-api-name }} на получение генеративного ответа отправляются методом POST на эндпойнт `{{ link-yandex }}/search/xml/generative`. 

Для выполнения запросов необходим [сервисный аккаунт](../../iam/concepts/users/service-accounts.md) с [ролью](../security/index.md#search-api-executor) `search-api.executor` и созданный для него [API-ключ](../../iam/concepts/authorization/api-key.md). Для успешной [авторизации](../operations/auth.md) передавайте в каждом запросе [идентификатор каталога](../../resource-manager/operations/folder/get-id.md) и API-ключ сервисного аккаунта.

### Формат запроса {#body}

Каждый запрос на получение генеративного ответа должен содержать тело запроса в формате [JSON](https://ru.wikipedia.org/wiki/JSON) следующего вида:

```json 
{
  "messages": [
    {
      "content": "<текст_сообщения_1>",
      "role": "user"
    },
    {
      "content": "<ответ_модели_1>",
      "role": "assistant"
    },
    {
      "content": "<текст_сообщения_2>",
      "role": "user"
    },
    {
      "content": "<ответ_модели_3>",
      "role": "assistant"
    },
    ...
    {
      "content": "<текст_сообщения_n>",
      "role": "user"
    }
  ],
  "site": "<адрес_сайта_для_поиска>",
  "host": "<хост_для_поиска>"
}
```

### Параметры запроса

* `messages` — одиночный поисковый запрос или поисковый запрос с контекстом в форме чата с моделью. Задается в виде массива объектов, в каждом из которых содержатся два элемента:
    * `content` — текст запроса пользователя или ответа модели (в зависимости от значения элемента `role`).
    * `role` — роль автора сообщения. Возможные значения:
        * `user` — означает, что автор сообщения — пользователь, а в поле `content` — запрос пользователя.
        * `assistant` — означает, что автор сообщения — модель, а в поле `content` — ответ модели.

    Подробнее о режиме чата в {{ yagpt-name }} см. в разделе [{#T}](../../foundation-models/operations/yandexgpt/create-chat.md).

* `site` — ограничение области поиска релевантных документов по сайту, например `mos.ru`.

    Поиск будет выполняться по всем документам вида `*.mos.ru/*`. То есть, в область поиска попадут документы со следующими адресами:
    * `mos.ru/`
    * `subdomain.mos.ru/`
    * `mos.ru/path/`
    * `subdomain.mos.ru/path/`

    В поле `site` можно указать конкретный путь к области поиска, например `mos.ru/feedback/faq`.
 
* `host` — ограничение области поиска релевантных документов по хосту, например `mos.ru`.

    Поиск будет выполняться по всем документам вида `mos.ru/*`. То есть, в область поиска попадут документы со следующими адресами:
    * `mos.ru/`
    * `mos.ru/path/`

    В отличие от ограничения области поиска в поле `site`, заданное в поле `host` ограничение не распространяется на поддомены. В поле `host` также нельзя указать конкретный путь к области поиска.

    {% note info %}

    Приоритет поля `host` выше, чем у поля `site`. Если в запросе передаются оба поля, область поиска будет ограничена значением поля `host`, а значение поля `site` будет проигнорировано.

    {% endnote %}

Пример тела запроса:

```json
{
  "messages": [
    {
      "content": "Где получить карту москвича?",
      "role": "user"
    }
  ],
  "site": "mos.ru"
}
```

### Отправка запроса {#send-request}

Чтобы отправить запрос, воспользуйтесь утилитой [cURL](https://curl.haxx.se) или языком программирования [Python](https://python.org/). Перед отправкой запроса сохраните [идентификатор каталога](../../resource-manager/operations/folder/get-id.md) и [API-ключ](../../iam/concepts/authorization/api-key.md) вашего сервисного аккаунта в переменные окружения:

```bash
export FOLDER-ID=<идентификатор_каталога>
export API-KEY=<API-ключ>
```

{% list tabs group=programming_language %}

- cURL {#curl}

  ```bash
  curl -X POST \
    -H "Authorization: Api-Key ${API-KEY}" \
    -d "@<путь_к_файлу_с_телом_запроса>" \
  "{{ link-yandex }}/search/xml/generative?folderid=${FOLDER-ID}"  
  ```

- Python 3 {#python}

  ```python
  import requests

  SEARCH_API_GENERATIVE = "https://ya.ru/search/xml/generative"


  def main():
    messages = []
    while True:
      prompt = input("[User]: ")
      messages.append({"content": prompt, "role": "user"})
      response = requests.post(SEARCH_API_GENERATIVE, json={
        "messages": messages
      }).json()

      print("[Generative]:", response["message"]["content"])
      for i, link in enumerate(response["links"], start=1):
        print(f"[{i}]: {link}")
      messages.append(response["message"])

  
  if __name__ == "__main__":
    main()
  ```

{% endlist %}

## Генеративный ответ {#response}

Сервис {{ search-api-name }} возвращает ответ в формате JSON следующего вида:

```json
{
  "message": {
    "content": "<текст_ответа>",
    "role": "assistant"
  },
  "links": [
    "<ссылка_на_найденный_документ_1>",
    "<ссылка_на_найденный_документ_2>",
    ...
    "<ссылка_на_найденный_документ_n>"
  ],
  "final_search_query": "<доработанный_текст_запроса>",
  "is_answer_rejected": false(true)
}
```

Где:
* `content` — текст генеративного ответа.
* `links` — отсортированный список ссылок на документы, которые были найдены при запросе и могли использоваться {{ yagpt-name }} для формирования ответа.
* `final_search_query` — конечный вариант текста поискового запроса, доработанный моделью {{ yagpt-name }} и использованный при формировании генеративного ответа. Может отличаться от запроса, изначально переданного пользователем.
* `is_answer_rejected` — индикатор отказа модели предоставить ответ из-за этических ограничений:

    * `false` — модель вернула ответ.
    * `true` — модель отказалась вернуть ответ.

Пример генеративного ответа:

```json
{
  "message": {
    "content": "**Карту москвича можно получить в центре «Мои документы»** [1].\n\n**Для этого необходимо:**\n\n1. **Заполнить заявление на выпуск карты москвича онлайн на mos.ru** [1]. Для этого потребуется стандартная учётная запись в личном кабинете mos.ru [1].\n\n2. **Дождаться уведомления о готовности карты** [1]. Карта москвича будет готова в течение 30 дней после подачи документов [1]. Как только карта будет готова, в личный кабинет на mos.ru придёт соответствующее сообщение [1].\n\n3. **Получить карту в выбранном центре «Мои документы»** [1]. Для этого понадобится документ, удостоверяющий личность, который был указан в заявлении, и документ, подтверждающий льготную категорию (если в уведомлении указана необходимость его предоставить) [1]. Если карту получает представитель — документы, подтверждающие его полномочия и копия документа, удостоверяющего личность гражданина, на которого выпущена карта [1].\n\nДошкольники старше 7 лет, учащиеся московских школ и колледжей смогут забрать карту москвича в учебном заведении [1].\n\n**Более подробную информацию можно получить:**\n\n* по телефону горячей линии для держателей карты москвича: +7 (495) 539-55-55 [1];\n\n* по телефонам контакт-центра «Московский транспорт»: +7 (495) 539-54-54, 3210 (с мобильного телефона) — по вопросам использования карты в транспорте [1].",
    "role": "assistant"
  },
  "links": [
    "https://www.mos.ru/otvet-socialnaya-podderjka/kak-oformit-kartu-moskvicha/",
    "https://www.mos.ru/karta-moskvicha/predpensionera/",
    "https://www.mos.ru/karta-moskvicha/pensionera/",
    "https://www.mos.ru/news/item/128668073/",
    "https://www.mos.ru/pgu/ru/services/link/5633/"
  ],
  "final_search_query": "Где получить карту москвича?",
  "is_answer_rejected": false
}
```

### Особенности ответа {#special-circumstances}

В зависимости от запроса и полученных результатов поиска, при формировании генеративного ответа {{ search-api-name }} может выдавать такие предупреждения:

* Если сервис не нашел ни одного документа по запросу:

    > **Ничего не нашлось.**
    > Переформулируйте запрос или спросите что-нибудь ещё.

* Если сервис нашел документы-источники по запросу, но извлечь из них информацию не получилось:

    > Не удалось извлечь информацию по запросу из найденных документов. Попробуйте открыть их самостоятельно или перейти к результатам поиска.

* Если сервис нашел документы-источники и извлек из них информацию, но нет уверенности в высоком качестве ответа, {{ search-api-name }} предваряет ответ следующим сообщением:

    > На сайтах по данной теме доступна различная информация, её обзор ниже. Если вы считаете его некачественным, сообщите нам об этом, воспользовавшись кнопкой под ответом.