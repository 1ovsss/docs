# Получение статистики запросов к объектам {{ objstorage-full-name }} с использованием {{ yq-full-name }}


Получите статистику запросов к объектам {{ objstorage-name }} с помощью [{{ yq-full-name }}](../../query/concepts/index.md).

{% note info %}

Чтобы получить информацию о запросах к объектам, [включите механизм логирования](../operations/buckets/enable-logging.md#enable).

{% endnote %}

## Настройка подключений в {{ yq-full-name }} {#yq}

1. Перейдите в [{{ yq-full-name }}](https://yq.yandex.cloud).
1. Нажмите на кнопку **Создать соединение**, чтобы установить [соединение](../../query/concepts/glossary.md#connection) с бакетом, содержащим статистику. Заполните поля:
   1. В поле **Имя** укажите название соединения, например `bucket_logs_connection`.
   1. В поле **Тип** выберите **Object Storage**.
   1. В поле **Аутентификация бакета** выберите **Приватный**.
   1. В поле **Облако и каталог** выберите облако и каталог, где хранится статистика запросов к объектам.
   1. В поле **Бакет** выберите бакет, где хранится статистика запросов к объектам.
   1. В поле **Сервисный аккаунт** выберите [сервисный аккаунт](../../iam/concepts/users/service-accounts.md), от имени которого будет выполняться доступ к данным в бакете.
   1. Нажмите кнопку **Проверить**. После успешной проверки нажмите кнопку **Создать**.
1. Перейдите в раздел **Привязки** и нажмите кнопку **Создать**, чтобы использовать ранее созданное соединение. Подробнее о [привязках к данным](../../query/concepts/glossary.md#binding).
1. Заполните следующие поля:
   1. В поле **Тип** выберите пункт **Object Storage**.
   1. В поле **Имя** укажите название соединения, например `bucket_logs`.
   1. В поле **Соединение** укажите название соединения, созданного на предыдущем шаге.
   1. Нажмите кнопку **Автоматически заполнить настройки для** и в выпадающем списке выберите **Object Storage Access Logs**.
   1. В поле **Путь** укажите путь к данным статистики внутри бакета. Если данные статистики хранятся в корневой директории бакета, укажите `/`.
   1. Нажмите кнопку **Предпросмотр** для проверки правильности настроек.
   1. Завершите создание привязки к данным, нажав кнопку **Создать**.

## Получение статистики запросов {#request-stat}

### Базовый запрос
```sql
SELECT `timestamp`, request_id, handler, object_key, status, request_time
FROM bucket_logs
LIMIT 100
```
Такой запрос вернет 100 записей со статистикой запросов к объектам {{ objstorage-full-name }}. Лимит записей можно снять, а результаты фильтровать с помощью `WHERE`. Ниже приведены несколько подобных сценариев.

### Поиск запросов по коду ответа

```sql
SELECT `timestamp`, request_id, handler, object_key, status, request_time
FROM bucket_logs
WHERE status >= 400
```

### Поиск долго обрабатываемых запросов

```sql
SELECT `timestamp`, request_id, handler, object_key, status, request_time
FROM bucket_logs
WHERE request_time >= 1000
```

### Среднее время обработки запросов

В примере используется агрегатная функция `AVG`.

```sql
SELECT AVG(request_time) AS `avg` FROM bucket_logs
```

